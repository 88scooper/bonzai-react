# Data Migration Guide

## Overview

This guide explains how to migrate your existing localStorage data to the Neon database.

## What Gets Migrated

The migration script will move:
- ✅ **Accounts** - All user accounts from localStorage
- ✅ **Properties** - All properties for each account
- ✅ **Mortgages** - Mortgage data associated with properties
- ✅ **Expenses** - Expense history for each property

## How to Run the Migration

### Option 1: Using the Web Interface (Recommended)

1. **Make sure you're logged in**
   - Go to `/login` and log in with your account
   - Or create a new account at `/signup`

2. **Navigate to the migration page**
   - Go to `/migrate` in your browser
   - Or click the migration link if available

3. **Check for data**
   - The page will automatically check if you have data in localStorage
   - If no data is found, you'll see a message

4. **Start the migration**
   - Click "Start Migration" button
   - Confirm the migration when prompted
   - Watch the progress bar and messages

5. **Review results**
   - After completion, you'll see:
     - Number of accounts created
     - Number of properties created
     - Number of mortgages created
     - Number of expenses created
     - Any errors that occurred

### Option 2: Programmatic Migration

If you need to run the migration programmatically:

```typescript
import { migrateLocalStorageToDatabase } from '@/lib/migrate-localStorage-to-db';

// Run migration with progress callback
const result = await migrateLocalStorageToDatabase((message, progress) => {
  console.log(`${progress}%: ${message}`);
});

console.log('Migration result:', result);
```

## Before Migration

### Prerequisites

1. ✅ **Database is set up**
   - Neon database is configured
   - Migrations have been run
   - Connection string is in `.env.local`

2. ✅ **You're logged in**
   - You have a user account
   - JWT token is stored in localStorage

3. ✅ **You have data in localStorage**
   - Accounts exist in `proplytics_accounts`
   - Properties exist in `proplytics_account_data_*`

### Backup (Optional but Recommended)

Before migrating, you can backup your localStorage data:

```javascript
// In browser console
const backup = {
  accounts: localStorage.getItem('proplytics_accounts'),
  currentAccount: localStorage.getItem('proplytics_current_account'),
  // Get all account data
  accountData: {}
};

// Get all account data keys
Object.keys(localStorage).forEach(key => {
  if (key.startsWith('proplytics_account_data_')) {
    backup.accountData[key] = localStorage.getItem(key);
  }
});

// Download as JSON
const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = 'proplytics-backup.json';
a.click();
```

## During Migration

### What Happens

1. **Accounts are created first**
   - Each localStorage account becomes a database account
   - Account IDs are generated by the database (UUIDs)

2. **Properties are created for each account**
   - Properties are linked to the new account ID
   - Property data is mapped to the new schema

3. **Mortgages are created**
   - Each property's mortgage is created via the API
   - Linked to the new property ID

4. **Expenses are created**
   - All expenses from `expenseHistory` are created
   - Linked to the new property ID

### Progress Tracking

- Progress bar shows 0-100%
- Messages indicate current step
- Errors are logged but don't stop the migration

## After Migration

### Verify the Migration

1. **Check your accounts**
   - Go to `/my-properties` or account switcher
   - Verify all accounts are present

2. **Check your properties**
   - View properties list
   - Open individual properties
   - Verify all data is correct

3. **Check mortgages and expenses**
   - Open property details
   - Verify mortgages are present
   - Verify expenses are present

### Clean Up (Optional)

After verifying the migration worked:

1. **Clear localStorage** (optional)
   ```javascript
   // In browser console
   localStorage.removeItem('proplytics_accounts');
   localStorage.removeItem('proplytics_current_account');
   Object.keys(localStorage).forEach(key => {
     if (key.startsWith('proplytics_account_data_')) {
       localStorage.removeItem(key);
     }
   });
   ```

2. **Or keep it as backup**
   - localStorage data can remain as a backup
   - It won't interfere with the new system

## Troubleshooting

### "No data found in localStorage"

**Cause:** No accounts or properties in localStorage

**Solution:** 
- Check if you have data in localStorage
- Open browser DevTools → Application → Local Storage
- Look for `proplytics_accounts` key

### "Authentication required" errors

**Cause:** Not logged in or token expired

**Solution:**
- Log out and log back in
- Go to `/migrate` again

### "Failed to create account/property"

**Cause:** API error or validation failure

**Solution:**
- Check browser console for detailed error
- Verify database connection
- Check that all required fields are present in localStorage data

### Migration partially completes

**Cause:** Some items failed but others succeeded

**Solution:**
- Review the error list in the results
- Fix any data issues
- Re-run migration (it will skip already-created items or create duplicates - you may need to clean up first)

## Data Mapping

### Account Mapping
- `id` → Generated by database (UUID)
- `name` → `name`
- `email` → `email`
- `isDemo` → `is_demo`
- `createdAt` → `created_at` (auto-generated)

### Property Mapping
- `nickname` or `name` → `nickname`
- `address` → `address`
- `purchasePrice` → `purchase_price`
- `purchaseDate` → `purchase_date`
- `closingCosts` → `closing_costs`
- `currentMarketValue` or `currentValue` → `current_market_value`
- `propertyType` or `type` → `property_type`
- `size` or `squareFootage` → `size`
- Additional fields → `property_data` (JSONB)

### Mortgage Mapping
- `lenderName` or `lender` → `lender`
- `originalAmount` or `principal` → `original_amount`
- `interestRate` or `rate` → `interest_rate`
- `rateType` → `rate_type`
- `termYears` → `term_months` (converted)
- `amortizationYears` or `amortizationPeriodYears` → `amortization_years`
- `paymentFrequency` → `payment_frequency`
- `startDate` → `start_date`

### Expense Mapping
- `date` → `date`
- `amount` → `amount`
- `category` → `category`
- `description` or `note` → `description`
- Additional fields → `expense_data` (JSONB)

## Support

If you encounter issues:
1. Check the browser console for errors
2. Check the migration results page for error details
3. Verify your database connection
4. Ensure you're logged in

---

**Note:** The migration is one-way. Once data is in the database, the app will use the database as the source of truth. localStorage data can be kept as backup but won't be used by the app anymore.

